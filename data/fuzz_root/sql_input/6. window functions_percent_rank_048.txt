CREATE TABLE t0(c0 INTEGER, c1 DOUBLE, c2 FLOAT, c3 TEXT, c4 FLOAT); INSERT INTO t0(c0, c1, c2, c3, c4) VALUES (1, 10.0, -0.1, 'x', -0.5), (2, -20.0, 0.2, 'y', 0.5), (3, 30.0, -0.3, 'z', -0.6), (4, -40.0, 0.4, 'x', 0.7), (5, 50.0, -0.5, 'y', -0.8); SELECT c0, c1, c2, c3, c4, PERCENT_RANK() OVER (PARTITION BY c4 < 0 ORDER BY CASE WHEN c3 LIKE 'x%' THEN c1 + c2 ELSE ABS(c4 * c1) END DESC) AS rank_percent FROM t0;