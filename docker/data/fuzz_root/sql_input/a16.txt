CREATE TABLE t0 (c0 INTEGER PRIMARY KEY, c1 JSON); INSERT INTO t0 (c0, c1) VALUES (1, '{"name": "Alice", "age": 30, "department": "HR", "salary": 70000}'), (2, '{"name": "Bob", "age": 25, "department": "Engineering", "salary": 80000}'), (3, '{"name": "Charlie", "age": 28, "department": "Marketing", "salary": 60000}'), (4, '{"name": "David", "age": 35, "department": "HR", "salary": 75000}'), (5, '{"name": "Eve", "age": 29, "department": "Engineering", "salary": 85000}'); SELECT v0.c0, v0.c1 AS name, v0.c2 AS department, v0.c3 AS salary, LAG(v0.c3, 1, 0) OVER (PARTITION BY v0.c2 ORDER BY v0.c3 DESC) AS prev_salary, LEAD(v0.c3, 1, 0) OVER (PARTITION BY v0.c2 ORDER BY v0.c3 DESC) AS next_salary, (v0.c3 - LAG(v0.c3, 1, 0) OVER (PARTITION BY v0.c2 ORDER BY v0.c3 DESC)) AS salary_diff FROM (SELECT c0, c1 -> '$.name' AS c1, c1 -> '$.department' AS c2, CAST(c1 -> '$.salary' AS DOUBLE) AS c3, ROW_NUMBER() OVER (PARTITION BY c1 -> '$.department' ORDER BY CAST(c1 -> '$.salary' AS DOUBLE) DESC) AS dept_rank FROM t0) AS v0 WHERE v0.dept_rank <= 2 ORDER BY v0.c2, v0.c3 DESC;