CREATE TABLE t0 (data JSON); INSERT INTO t0 VALUES ('{"id": 1, "info": {"name": "Alice", "scores": {"math": 85, "science": 92}, "location": {"age": 25, "city": "New York"}}}'), ('{"id": 2, "info": {"name": "Bob", "scores": {"math": 78, "science": 81}, "location": {"age": 28, "city": "Los Angeles"}}}'), ('{"id": 3, "info": {"name": "Charlie", "scores": {"math": 90, "science": 88}, "location": {"age": 23, "city": "Chicago"}}}'), ('{"id": 4, "info": {"name": "Diana", "scores": {"math": 95, "science": 85}, "location": {"age": 27, "city": "Houston"}}}'); WITH extracted_data AS (SELECT data -> '$.info.name' AS name, CAST(data -> '$.info.scores.math' AS INTEGER) AS math_score, data -> '$.info.location.city' AS location FROM t0) SELECT name, math_score, AVG(math_score) OVER (PARTITION BY location ORDER BY math_score) AS avg_math_by_location FROM extracted_data;